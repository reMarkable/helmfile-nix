name: Run integration tests

on:
  pull_request:

jobs:
  integrationtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - run: docker build --load -t helmfile-nix .
      - name: Create KIND Cluster
        uses: helm/kind-action@ef37e7f390d99f746eb8b610417061a60e82a6cc # v1.14.0
        with:
          kubeconfig: ./kubeconfig
      - run: kubectl cluster-info --context kind-chart-testing --kubeconfig kubeconfig
      - run: docker run --network=host -v .:/app -e KUBECONFIG=/app/kubeconfig helmfile-nix apply -f /app/testData/helm-nixchart
      - run: docker run --network=host -v .:/app -e KUBECONFIG=/app/kubeconfig helmfile-nix diff -f /app/testData/helm-nixchart
